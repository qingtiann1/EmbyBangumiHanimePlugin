<!DOCTYPE html>
<html>
<head>
    <title>Bangumi & Hanime 配置</title>
</head>
<body>
    <div data-role="page" class="type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <h1>Bangumi & Hanime 插件配置</h1>

                <form id="bangumiHanimeConfigForm">

                    <div class="section" style="margin-bottom: 2em; border: 1px solid #444; padding: 1em; border-radius: 5px;">
                        <h2 style="margin-top:0;">Bangumi (bgm.tv)</h2>
                        <p class="fieldDescription">由于 Emby 插件内无法直接弹出浏览器，请在本地先获取 Access Token，或填写初始 Token，插件将自动尝试刷新。</p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="bangumiAccessToken">Access Token</label>
                            <input is="emby-input" type="text" id="bangumiAccessToken" name="bangumiAccessToken" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="bangumiRefreshToken">Refresh Token (用于自动续期)</label>
                            <input is="emby-input" type="text" id="bangumiRefreshToken" name="bangumiRefreshToken" />
                        </div>
                        <div class="fieldDescription">有效期截止: <span id="tokenExpiryDisplay">未知</span> (插件运行时自动更新)</div>
                    </div>

                    <div class="section" style="margin-bottom: 2em; border: 1px solid #444; padding: 1em; border-radius: 5px;">
                        <h2 style="margin-top:0;">Hanime1.me</h2>
                        <p class="fieldDescription">建议使用 Cookie 方式，避免验证码问题。</p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="hanimeCookie">Cookie 字符串</label>
                            <input is="emby-input" type="text" id="hanimeCookie" name="hanimeCookie" placeholder="XSRF-TOKEN=...; hanime1_session=..." />
                            <div class="fieldDescription">请在浏览器登录 hanime1.me 后，按 F12 打开控制台 -> 网络 -> 刷新页面 -> 找到请求头中的 Cookie 复制到此处。</div>
                        </div>
                    </div>

                    <br />
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>保存</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            // Emby 插件配置页面的标准 JS 闭包写法
            var BangumiHanimePluginConfig = {
                pluginUniqueId: "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890" // 必须与 Plugin.cs 中的 Id 一致
            };

            (function () {
                $('.pluginConfigurationPage').on('pageshow', function () {
                    Dashboard.showLoadingMsg();
                    var page = this;

                    // 加载配置
                    ApiClient.getPluginConfiguration(BangumiHanimePluginConfig.pluginUniqueId).then(function (config) {
                        $('#bangumiAccessToken', page).val(config.BangumiAccessToken || '');
                        $('#bangumiRefreshToken', page).val(config.BangumiRefreshToken || '');
                        $('#hanimeCookie', page).val(config.HanimeCookie || '');
                        
                        if(config.BangumiTokenExpiry) {
                            $('#tokenExpiryDisplay', page).text(new Date(config.BangumiTokenExpiry).toLocaleString());
                        }

                        Dashboard.hideLoadingMsg();
                    });
                });

                $('#bangumiHanimeConfigForm').on('submit', function () {
                    Dashboard.showLoadingMsg();
                    var page = $(this).parents('.pluginConfigurationPage')[0];

                    ApiClient.getPluginConfiguration(BangumiHanimePluginConfig.pluginUniqueId).then(function (config) {
                        config.BangumiAccessToken = $('#bangumiAccessToken', page).val();
                        config.BangumiRefreshToken = $('#bangumiRefreshToken', page).val();
                        config.HanimeCookie = $('#hanimeCookie', page).val();

                        ApiClient.updatePluginConfiguration(BangumiHanimePluginConfig.pluginUniqueId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });

                    return false;
                });
            })();
        </script>
    </div>
</body>
</html>
